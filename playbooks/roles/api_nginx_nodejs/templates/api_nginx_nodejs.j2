#managed by ansible 
#file api_nginx_nodejs/templates/api_nginx_nodejs.yml

# IP which nodejs is running on
upstream node_api {
    server 127.0.0.1:{{api_node_port}};
}

events {
        worker_connections {{nginx_worker_connections}};
}

# nginx server instance
server {

    listen 80;
    server_name {{ api_nginx_server_name }};

    charset utf-8;

    location / {
        root {{ nginx_root }};
        index index.html index.htm;
        try_files $uri $uri/ @node;
    }

    # proxy_pass to the upstream node app. 
    # use X-Forwarded-For when proxying so we can see where the req came from
    location @node {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_pass http://node_api;
    }

    # serve static files directly
    location ~* ^.+.(jpg|jpeg|gif|css|png|js|ico)$ {
        access_log        off;
        expires           30d;
    }

    access_log {{nginx_log_file_access}};
    error_log {{nginx_log_file_error}};

}
